<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>OneShot Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-messaging-compat.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
</head>

<body>
    <div id="outer-frame" class="flex">
        <!-- Sidebar -->
        <div id="sidebar" class="w-1/4 bg-gray-300 p-4">
            <button id="copyToken" class="w-full p-2 bg-green-500 text-white mb-2">Copy Token</button>
            <button id="startSocket" class="w-full p-2 bg-green-500 text-white mb-2">Start Socket</button>
            <button id="makeToken" class="w-full p-2 bg-green-500 text-white mb-2">Make Token</button>
            <button id="version" class="w-full p-2 bg-blue-500 text-white mb-2">/version</button>
            <button id="viewOneshot" class="w-full p-2 bg-blue-500 text-white mb-2">/api/oneshot/view</button>
            <button id="postOneshot" class="w-full p-2 bg-blue-500 text-white mb-2">/api/oneshot/post</button>
            <button id="editOneshot" class="w-full p-2 bg-blue-500 text-white mb-2">/api/oneshot/edit</button>
            <button id="deleteOneshot" class="w-full p-2 bg-blue-500 text-white mb-2">/api/oneshot/delete</button>
            <button id="getNickname" class="w-full p-2 bg-blue-500 text-white mb-2">/api/user/get-nickname</button>
            <button id="setNickname" class="w-full p-2 bg-blue-500 text-white mb-2">/api/user/set-nickname</button>
            <button id="subscribeNotifications" class="w-full p-2 bg-green-500 text-white mb-2">Subscribe to notifications</button>
        </div>
        <input id="custom" type="text" placeholder="You only get one shot" />
        <!-- Content -->
        <div id="content" class="w-3/4 p-4">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
    <div id="firebaseui-auth-container"></div>
    <button id="logout-button" onclick="firebase.auth().signOut();"
        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"> Logout </button>
    <button onclick="validateAddress('via gorizia spresiano')"
        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"> validateaddress </button>

    <script>
        let messaging;
        let basicurl = window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
        $('#makeToken').click(_ => {
            _USER.getIdToken()
            .then(accessToken => {
                try {
                    console.log(firebase);
                    
                    messaging = firebase.messaging();
                    
                    messaging.onMessage((payload) => {
                        console.log('Message received. ', payload);
                        // ...handle/show the notification or any other task
                    });

                } catch (error) {
                    console.log(error);
                }
            });
        })
        $('#copyToken').click(_ => {
            _USER.getIdToken()
            .then(accessToken => {
                navigator.clipboard.writeText(accessToken);
            });
        })
        $('#startSocket').click(_ => {
            _USER.getIdToken()
            .then(accessToken => {
                const socket = io.connect('http://localhost:8080', {
                    query: { token: accessToken }
                });

                socket.on('connect', () => {
                    console.log('Connected');
                });

                socket.on('join-request', (data) => {
                    console.log('Join request received');
                    console.log(data);
                });

                socket.on('message', (data) => {
                    console.log('message received');
                    console.log(data);
                });
            });
        })
        
        $('#subscribeNotifications').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/notifications/subscribe", {
                method: "POST",
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: 'u9yd98t6q72h9un0b87g1ty82u9dycewjiow',
                    type: 'newOneshot',
                    viaEmail: true,
                    preferences: {
                        city: "Spresiano",
                        radius: 10,
                        weekGrid: [
                            ["tuesday", 19, 23],
                        ],
                    }
                })
            }).then(response => response.json()).then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            }));
        })
        
        $('#setNickname').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/user/set-nickname", {
                method: 'POST',    
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nickname: document.getElementById('custom').value,
                }),
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#getNickname').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/user/startup", {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#viewOneshot').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/oneshot/view/" + document.getElementById("custom").value, {
                method: 'GET',    
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#editOneshot').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/oneshot/edit/" + document.getElementById("custom").value, {
                method: 'PUT',    
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: '2023-09-23',
                    place: 'Spresiano city',
                    title: 'Una bella sorpresa',
                    description: 'Vi svegliate nudi',
                    time: '20:00',
                    max_players: 2,
                    out_players: 2,
                    characters_level: 3,
                    extra_info: 'No fumatori, alcol ben accetto',
                }),
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#postOneshot').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/oneshot/post", {
                method: 'POST',    
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: '2023-09-23',
                    place: 'Spresiano city',
                    title: 'Una brutta sorpresa',
                    description: 'Vi svegliate in una stanza completamente buia',
                    time: '20:00',
                    max_players: 2,
                    out_players: 2,
                    characters_level: 3,
                    extra_info: 'No fumatori, birra ben accetta',
                }),
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#deleteOneshot').click(_ => {
            _USER.getIdToken()
            .then(accessToken => fetch(basicurl + "/api/oneshot/delete/" + document.getElementById("custom").value, {
                method: 'DELETE',    
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                },
            })
            )
            .then(response => response.json())
            .then(data => {
                $('#content').html(JSON.stringify(data, null, 4));
            });
        });
        
        $('#version').click(_ => {
            fetch(basicurl + "/version")
            .then(response => response.text())
            .then(data => {
                $('#content').html(data);
            });
        });

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoy5EAXOnBuK4u1DXCSF1JQ-02qvxC_Lk",
            authDomain: "questfinder-dd466.firebaseapp.com",
            projectId: "questfinder-dd466",
            storageBucket: "questfinder-dd466.appspot.com",
            messagingSenderId: "429219253172",
            appId: "1:429219253172:web:1f4bc0ef954263b36900e1",
            measurementId: "G-PV4ZQTB0SC"
        };
        var uiConfig = {
            signInSuccessUrl: basicurl,
            signInOptions: [
                // Leave the lines as is for the providers you want to offer your users.
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            ],
            // tosUrl and privacyPolicyUrl accept either url string or a callback
            // function.
            // Terms of service url/callback.
            tosUrl: 'thewebmaker.it',
            // Privacy policy url/callback.
            privacyPolicyUrl: function () {
                window.location.assign('thewebmaker.it');
            }
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // Initialize the FirebaseUI Widget using Firebase.
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        // The start method will wait until the DOM is loaded.
        ui.start('#firebaseui-auth-container', uiConfig);

        let _USER = null;
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                _USER = user;
                console.log(_USER);
                console.log('User is signed in');
            } else {
                // User is signed out.
                console.log('User is signed out');
            }
        });

        function validateAddress(address) {
            // prompt the user with a choice: use the browser's geolocation or type in their address and let's hope they are lazy and choose the first option
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    alert(position.coords.latitude + ',' + position.coords.longitude)
                },
                () => {
                    alert('Position could not be determined.');
                }
            );
            let key = 'AIzaSyCIWqu8UMh3Q_X-xZSVAnN6RP4SLddQExg';
            let endpoint = `https://addressvalidation.googleapis.com/v1:validateAddress?key=${key}`;
            let params = {
                address: {
                    regionCode: 'IT',
                    addressLines: [address],
                }
            };
            $.ajax({
                url: endpoint,
                type: 'POST',
                data: JSON.stringify(params),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    // put .address.formattedAddress in #address
                    // then put .geocode.location (which has .latitude and .longitude) in const location, send it to the server
                    console.log(data);
                    data = data.result;
                    let address = data.address.formattedAddress;
                    let location = data.geocode.location;
                    alert(address);
                    console.log(location);
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

    </script>
</body>

</html>
